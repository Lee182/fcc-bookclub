{"version":3,"sources":["webpack:///webpack/bootstrap a5525aaa761b6d420b23","webpack:///./shared/eventSystem.js","webpack:///./server/api/book.coffee","webpack:///./server/index.coffee","webpack:///external \"http\"","webpack:///external \"path\"","webpack:///external \"express\"","webpack:///external \"body-parser\"","webpack:///external \"cookie-parser\"","webpack:///./server/express/user.coffee","webpack:///./server/express/twitter_session.coffee","webpack:///external \"login-with-twitter\"","webpack:///./server/express/book.coffee","webpack:///external \"google-books-search\"","webpack:///./server/ws/index.coffee","webpack:///./server/ws/user_connect_disconnect_handle.coffee","webpack:///./server/ws/comms.server.coffee","webpack:///external \"uws\"","webpack:///./server/keys.coffee","webpack:///./server/db.coffee","webpack:///external \"mongodb\"","webpack:///./server/api/ip2loci.coffee","webpack:///external \"curl\""],"names":[],"mappings":"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","file":"server.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 2);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap a5525aaa761b6d420b23","module.exports = function () {\n  var events = {}\n  var eventsystem = {\n    on: function (id, fn) {\n      events[id] = events[id] || []\n      events[id].push(fn)\n    },\n    off: function (id, fn) {\n      if (events[id] === undefined) { return }\n      var i = events[id].findIndex(function (g) {\n        return g = fn\n      })\n      if (i !== -1) {\n        events[id].splice(i, 1)\n      }\n    },\n    emit: function (id, data) {\n      if (events[id]) {\n        events[id].forEach(function (fn) {\n          fn(data)\n        })\n      }\n    }\n  }\n  eventsystem.events = events\n  return eventsystem\n}\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./shared/eventSystem.js\n// module id = 0\n// module chunks = 0","books = require('google-books-search')\no = {}\n\no.find = (query, pagenum) ->\n  if isNaN(pagenum)\n    pagenum = 0\n  limit = 20\n  offset = limit * pagenum\n  options =\n    offset: offset\n    limit: limit\n    type: 'books'\n    order: 'relevance'\n    lang: 'en'\n  new Promise((resolve, reject) ->\n    books.search query, options, (err, books, apires) ->\n      if err\n        return reject(err: err)\n      count = offset + limit\n      if apires != undefined and apires.totalItems != undefined\n        count = apires.totalItems\n      resolve\n        books: books\n        query: query\n        pagenum: pagenum + 1\n        pages: Math.ceil(count / limit)\n    return\n)\n\no.findId = (id) ->\n  new Promise((resolve, reject) ->\n    books.lookup id, (err, book) ->\n      if err or book == undefined\n        console.log 'db.js bookshelf__add err:', err\n        return reject(\n          err_msg: 'book_id not found'\n          err: err)\n      resolve book\n    return\n)\n\no._api = books\nmodule.exports = o\n\n\n// WEBPACK FOOTER //\n// ./server/api/book.coffee","import http  from 'http'\nimport path  from 'path'\nimport express from 'express'\nimport bodyParser from 'body-parser'\nimport cookieParser from 'cookie-parser'\nimport express_user from 'server/express/user.coffee'\nimport express_book from 'server/express/book.coffee'\nimport ws_handle from 'server/ws/index.coffee'\nimport k  from 'server/keys.coffee'\nimport db from 'server/db.coffee'\n\napp = express()\nserver = http.Server(app)\nport = process.argv[2] or 3000\ncookie_parser = cookieParser()\nbody_parser_json = bodyParser.json()\n\ndao = new db({ mongourl: k.mongourl })\napp.use cookie_parser\napp.use body_parser_json\napp.use '/', express.static(path.resolve(__dirname + '/dist'))\n\ntw = express_user({ app, port, dao, k, 'bookclub_sessions' })\nbookapi = express_book({ app, dao })\nws = ws_handle({ app, server, cookie_parser, tw, dao })\n\napp.get '*', (req, res) ->\n  console.log('here')\n  res.sendFile path.resolve(__dirname + '/dist/index.html')\n\ndao.connect().then ->\n  server.listen port, ->\n    console.log 'server listening at http://localho.st:' + port\n\n\n// WEBPACK FOOTER //\n// ./server/index.coffee","module.exports = require(\"http\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"http\"\n// module id = 3\n// module chunks = 0","module.exports = require(\"path\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"path\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"express\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"express\"\n// module id = 5\n// module chunks = 0","module.exports = require(\"body-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"body-parser\"\n// module id = 6\n// module chunks = 0","module.exports = require(\"cookie-parser\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"cookie-parser\"\n// module id = 7\n// module chunks = 0","Twitter_session = require('server/express/twitter_session.coffee')\n\nmodule.exports = ({ app, dao, port, k, sessiondb_name }) ->\n  \n  tw = Twitter_session({\n    dao,\n    port,\n    coll_name: sessiondb_name\n    consumerKey: k.twitter.consumerKey\n    consumerSecret: k.twitter.consumerSecret\n    callbackUrl: 'https://booktrade.blogjono.com/tw.login_cb' })\n\n  app.get '/tw.login', tw.login\n  \n  app.post '/tw.logout', tw.logout\n\n  app.get '/tw.login_cb', tw.login_cb, (req, res, next) ->\n    console.log req.twuser\n    if !req.twuser then return res.redirect '/'\n    user = await dao.user__findOne(user_id: req.twuser)\n    if !user\n      user = await dao.user__add(user_id: req.twuser)\n    if !user.loci\n      user = await dao.user__add_loci_fromip(user_id: user._id, ip: req.ip)\n    res.redirect '/?user_id=' + req.twuser\n\n\n  app.get '/user', tw.is_logged_in, (req, res, next) ->\n    user = await dao.user__findOne(user_id: req.twuser)\n    res.json user\n\n  app.post '/user/:user_id', (req, res) ->\n    user = await dao.user__findOne(user_id: req.params.user_id)\n    if !user\n    then res.json err: 'notfound'\n    else res.json user\n\n  app.post '/user_loci__change', tw.is_logged_in, (req, res, next) ->\n    result = await dao.user__change_loci(user_id: req.twuser, loci: req.body.loci)\n    res.json result\n\n  tw\n\n\n// WEBPACK FOOTER //\n// ./server/express/user.coffee","'use strict'\n# https://apps.twitter.com/app/new\nlogtwit = require('login-with-twitter')\nes = require('shared/eventSystem.js')\n\nmodule.exports = ({\n  dao,\n  port,\n  coll_name,\n  consumerKey,\n  consumerSecret,\n  callbackUrl\n}) ->\n  events = es()\n  tw = new logtwit({ consumerKey, consumerSecret, callbackUrl })\n  _tw_tokens = {}\n\n  return out =\n    events: events\n    login: (req, res, next) ->\n      tw.login (err, tokenSecret, url) ->\n        # console.log('tw.login', err, tokenSecret, url)\n        if err\n          return res.redirect('/')\n        oauth_token = url.split('oauth_token=')[1]\n        _tw_tokens[oauth_token] = tokenSecret\n        res.redirect url\n\n    login_cb: (req, res, next) ->\n      oauth_token = req.query.oauth_token\n      oauth_token_secret = _tw_tokens[oauth_token]\n      if oauth_token_secret == undefined\n        req.twerr = 'no oauth_token_secret'\n        return next()\n      tw.callback {\n        oauth_token: oauth_token\n        oauth_verifier: req.query.oauth_verifier\n      }, oauth_token_secret, (err, user) ->\n        # console.log('tw.callback', err, user)\n        if err\n          return next(err)\n        delete _tw_tokens[oauth_token]\n        res.cookie 'twitter', user.userToken,\n          expires: new Date(Date.now() + 1000 * 60 * 60 * 24 * 360)\n          httpOnly: true\n        \n        \n        query = _id: user.userToken\n        update =\n          $set:\n            creation_date: new Date\n            user_id: user.userName\n        options = upsert: true, returnOriginal: false\n        \n        result = await dao.db.collection(coll_name)\n        .findOneAndUpdate(queyr, update, options)\n        console.log 'tw', result\n        req.twuser = user.userName\n        next()\n\n    logout: (req, res, next) ->\n      # console.log('tw.logout',req.cookies)\n      events.emit 'logout',\n        user_id: req.twuser\n        req: req\n      await dao.db.collection(coll_name).remove(_id: req.cookies.twitter)\n      res.clearCookie 'twitter', path: '/'\n      res.json logout: true\n\n    is_logged_in: (req, res, next) ->\n      if not req.cookies or not req.cookies.twitter\n        return res.status(400).send('jog on')\n      try\n        result = await is_logged_in_prom(req.cookies.twitter)\n        if result == undefined\n          return res.clearCookie('twitter', path: '/')\n        req.twuser = result.user_id\n        next()\n      catch\n        next()\n\n    is_logged_in_prom: (cookie) ->\n      result = await dao.db.collection(coll_name).findOne(_id: cookie)\n      if result == null then undefined else result\n\n\n### Usage\napp.get('/twitter', tw.login)\n  // populates req.twerr\n  // redirects user to twitter.com\napp.get('/twitter-callback', tw.login_cb)\n  // populates req.twuser or req.twerr\n  // stores data in mongodb collection\napp.post('/twitter-logout')\n  // clears the twitter cookie\n###\n\n\n// WEBPACK FOOTER //\n// ./server/express/twitter_session.coffee","module.exports = require(\"login-with-twitter\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"login-with-twitter\"\n// module id = 10\n// module chunks = 0","bookapi = require('server/api/book')\n\nmodule.exports = ({ app, dao }) ->\n\n  app.get '/book_search/:query/:pagenum', (req, res) ->\n    if typeof req.params.query != 'string'\n      return res.status(400)\n    pagenum = Number(req.params.pagenum) - 1\n    try\n      data = await bookapi.find(req.params.query, pagenum)\n      res.json data\n    catch err\n      console.log 'express book_search', err\n      res.status 400\n\n  app.get '/book_id/:book_id', (req, res, next) ->\n    data = await dao.book__get(book_id: req.params.book_id)\n    if data\n      return res.json data\n    data = await bookapi.findId(req.params.book_id)\n    res.json data\n\n  app.get '/bookshelf/:user_id', (req, res, next) ->\n    result = await dao.bookshelf(user_id: req.params.user_id)\n    res.json result\n\n  app.get '/tradeshelf/:user_id', (req, res, next) ->\n    result = await dao.tradeshelf(user_id: req.params.user_id)\n    res.json result\n\n  app.get '/bookowners/:book_id', (req, res, next) ->\n    result = await dao.bookowners(book_id: req.params.book_id)\n    res.json result\n\n  app.get '/market/:page_n', (req, res, next) ->\n    result = dao.market(page_n: req.params.page_n)\n    res.json result\n\n  endpoints = [\n    'bookshelf__add'\n    'bookshelf__remove'\n    'trade__list'\n    'trade__unlist'\n    'trade__request'\n    'trade__request_remove'\n    'note__mark__read'\n    'note__mark__opened'\n    'trade_requests__get'\n    'trade_respond'\n  ]\n  endpoints.forEach (name) ->\n    app.post '/' + name, (req, res, next) ->\n      try\n        result = await dao[name] req.body\n        res.json result\n      catch err\n        console.log err\n        res.json\n          err: err\n          err_req: req.body\n  bookapi\n\n\n// WEBPACK FOOTER //\n// ./server/express/book.coffee","module.exports = require(\"google-books-search\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"google-books-search\"\n// module id = 12\n// module chunks = 0","handle_user_connects = require('server/ws/user_connect_disconnect_handle')\nComms = require('server/ws/comms.server')\n\nmodule.exports = ({\n  app,\n  server,\n  cookie_parser,\n  tw,\n  dao\n}) ->\n  comms = Comms(server)\n  users_online = []\n\n  get_user = (ws, user_id) ->\n    users_online.find (a) ->\n      a.ws == ws\n\n  get_user__comms = (user_id) ->\n    users_online.filter (a) ->\n      a.user_id == user_id\n\n  user_auth = (o, user_id) ->\n    user_id != undefined and\n    user_id != null and\n    o.user_id != undefined and\n    o.user_id != null and\n    o.user_id == user_id\n\n  handle_user_connects({ comms, cookie_parser, tw, users_online })\n  comms.on 'request', ({ data, ws }) ->\n    # for handling req response\n    # console.log('comms.request', data)\n    # example helloworld\n    a = get_user(ws)\n    b = data.data\n    if b.cmd == 'hello_world'\n      message = ''\n      if a.user_id == undefined\n        message = 'Hello! says mister express+ws server'\n      if a.user_id != undefined\n        message = 'Hello ' + a.user_id + '! hope your having a great time'\n      # send as a response\n      comms.send\n        ws: ws\n        data:\n          req_res: data.req_res\n          data: message: message\n\n  comms.on 'message', ({ data, ws }) ->\n    console.log 'data', data\n    user = get_user(ws)\n    valid_user = user_auth(user, data.user_id)\n\n  dao.e.on 'notify', (data) ->\n    channels = get_user__comms(data.user._id)\n    channels.forEach (channel) ->\n      comms.send\n        ws: channel.ws\n        data: data\n\n  dao.e.on 'book.update', (book) ->\n    comms.sendAll\n      book: book\n      cmd: 'book.update'\n\n  { users_online, comms }\n\n\n\n// WEBPACK FOOTER //\n// ./server/ws/index.coffee","module.exports = ({ comms, tw, cookie_parser, users_online }) ->\n  cook_p = (req) ->\n    new Promise (resolve) ->\n      # req.headers.cookies\n      cookie_parser req, {}, ->\n        resolve req.cookies\n\n  comms.on 'connection', (ws) ->\n    console.log 'comm.connection', ws._socket.remotePort\n    # ip === ws._socket.remoteAddress\n    # add nome to a list\n    users_online.push\n      ws: ws\n      user_id: undefined\n    headers = ws.upgradeReq.headers\n    cookies = await cook_p(ws.upgradeReq)\n    if cookies.twitter == undefined\n      comms.send({ ws, data: user_id: null })\n      return\n    { user_id } = await tw.is_logged_in_prom(cookies.twitter)\n    if user_id == undefined\n      comms.send\n        ws: ws\n        data: user_id: null\n      return\n    i = users_online.findIndex((o) -> ws == o.ws)\n    if i > -1\n      users_online[i].user_id = user_id\n    comms.send\n      ws: ws\n      data: user_id: user_id\n\n  comms.on 'close', (ws) ->\n    # remove from list\n    i = users_online.findIndex((o) -> ws == o.ws)\n    console.log 'comm.closed', users_online[i].user_id\n    users_online.splice i, 1\n\n  # used for live updating browser tabs when login or login\n  tw.events.on 'logout', (user) ->\n    console.log 'tw.logut', user\n    comms.sendAll reconnect: true\n\n  tw.events.on 'login', ->\n    # give, 1s for twitter, 1s for browsers to set cookies\n    setTimeout (-> comms.sendAll reconnect: true), 2000\n\n\n// WEBPACK FOOTER //\n// ./server/ws/user_connect_disconnect_handle.coffee","WebSocket = require('uws')\n# const BSON = require('bson')\n# const bson = new BSON()\neve = require('shared/eventSystem.js')\n# http://stackoverflow.com/questions/8609289/convert-a-binary-nodejs-buffer-to-javascript-arraybuffer\n# function ArrayBuffertoBuffer(ab) {\n#   var buf = new Buffer(ab.byteLength)\n#   var view = new Uint8Array(ab)\n#   for (var i = 0; i < buf.length; ++i) {\n#     buf[i] = view[i]\n#   }\n#   return buf\n# }\n# ws code\n\nsendBSON = ({ ws, data }) ->\n  if ws.readyState == WebSocket.OPEN\n    ws.send JSON.stringify(data)\n    # ws.send( bson.serialize(data, {ignoreUndefined: false}))\n\nmodule.exports = (server) ->\n  e = eve()\n  o = {}\n  wss = new (WebSocket.Server)(server: server)\n  wss.on 'connection', (ws) ->\n    e.emit 'connection', ws\n    ws.on 'message', (data, flags) ->\n      conn = this\n      try\n        data = JSON.parse(data)\n        # data = bson.deserialize(ArrayBuffertoBuffer(data))\n        if typeof data.req_res == 'number'\n          e.emit 'request', { data, ws: conn }\n        e.emit 'message', { data, ws: conn }\n      catch err\n    ws.on 'close', ->\n      e.emit 'close', ws\n\n  o.send = sendBSON\n\n  o.sendAll = (data) ->\n    wss.clients.forEach (ws) ->\n      sendBSON\n        ws: ws\n        data: data\n\n  o.sendAllExcept = ({ ws, data }) ->\n    wss.clients\n    .filter (client) ->\n      client == ws\n    .map (client) ->\n      sendBSON\n        ws: client\n        data: data\n\n  o.wss = wss\n  o.on = e.on\n  o.off = e.off\n  o\n\n###\ncomms.on('connection', ws)\ncomms.on('close', ws)\ncomms.on(\"message\", {data, ws})\n\ncomms.send({ws, data})\ncomms.sendAll(data)\ncomms.sendAllBut({ws, data})\n###\n\n\n\n// WEBPACK FOOTER //\n// ./server/ws/comms.server.coffee","module.exports = require(\"uws\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"uws\"\n// module id = 16\n// module chunks = 0","export default keys =\n  mongourl: 'mongodb://lee182:Mlab+jonomakesAgreatteam1@ds135577.mlab.com:35577/picput'\n  twitter:\n    consumerKey: 'FDa4QaYtWHKN6nbEAJnbuVkk2'\n    consumerSecret: 'zrB2M41vnghzqBOsvkUZbB93kaaPHnBkwCnlpimAx5uw7xQjQf'\n\n\n// WEBPACK FOOTER //\n// ./server/keys.coffee","# data acess object\nimport Mongo from 'mongodb'\nimport bookapi from 'server/api/book.coffee'\nimport ip2loci from 'server/api/ip2loci.coffee'\nimport eventSysetem from 'shared/eventSystem'\nMongoClient = Mongo.MongoClient\nbooksdb_name = 'bookshelf'\nusersdb_name = 'bookshelf_users'\n\nexport default class DB\n  constructor: ({ mongourl }) ->\n    @e = eventSysetem()\n    @db = null\n    @mongourl = mongourl\n    @ObjectId = Mongo.ObjectId\n    [\n      'bookshelf__add'\n      'bookshelf__remove'\n      'bookshelf__garbage_collection'\n      'trade__list'\n      'trade__unlist'\n      'trade__request'\n      # 'trade__request_remove'\n      'user__findOne'\n      'user__add'\n      'user__add_loci_fromip'\n      'user__change_loci'\n      'book__get'\n      'note__mark__read'\n      'note__mark__opened'\n      'trade_requests__get'\n      'trade_respond'\n    ].forEach (name) =>\n      @[name] = @ensureConnected(@[name])\n\n    five_mins = 5 * 60 * 1000\n    setInterval @bookshelf__garbage_collection, five_mins\n    @e.on 'trade.request', (info) ->\n      @notification__add\n        user_id: info.owner_id\n        info: info\n    @e.on 'trade.respond', (d) ->\n      console.log d\n      @notification__add\n        user_id: d.request._id.request.user_id\n        info:\n          type: 'trade.respond'\n          path: '/book/' + d.book._id\n          message: '''@${d.request._id.owner_id} ${d.words[0]}ed your trade request for \"${d.request.book.title}\"'''\n\n  ensureConnected: (fn) ->\n    if typeof fn != 'function'\n      debugger\n      throw Error 'ensureConnected passed fn'\n    ->\n      if @db == null then err: 'db disconnected'\n      fn.apply @, arguments\n  \n  db_paging: ({ db, coll, query, project, limit, page_n, sort }) ->\n    if limit == undefined then limit = 30\n    if page_n == undefined then page_n = 1\n    if sort == undefined then sort = _id: -1\n    if project == undefined then project = {}\n    skip = (page_n - 1) * limit\n    docs = await db.collection(coll)\n    .find(query, project)\n    .sort(sort)\n    .limit(limit)\n    .skip(skip)\n    .toArray()\n    { docs, limit, page_n, query }\n  \n  connect: ->\n    console.log 'mongo connnecting...'\n    try\n      @db = await MongoClient.connect(@mongourl)\n      console.log 'mongo connected'\n    catch err\n      @db = null\n      console.log 'mongo connection error:', err\n\n  user__findOne: ({ user_id }) ->\n    user = await @db.collection(usersdb_name).findOne(_id: user_id)\n    if user == null then undefined else user\n\n  user__add: ({ user_id }) ->\n    # TODO make sure user_id valid\n    result = @db.collection(usersdb_name).insert({\n      _id: user_id\n      user_id: user_id\n    }, returnOriginal: false)\n    result.ops[0]\n\n  user__add_loci_fromip: ({ user_id, ip }) ->\n    loci = await ip2loci(ip)\n    await @user__change_loci(user_id: user_id, loci: loci)\n\n  user__change_loci: ({ user_id, loci }) ->\n    # TODO make sure loci valid, then\n    res = await @db.collection(usersdb_name).findOneAndUpdate(\n      { _id: user_id },\n      { $set: loci: loci },\n      { returnOriginal: false, upsert: false })\n    res.value\n\n  bookshelf: ({ user_id }) ->\n    @db.collection(booksdb_name).find('users.user_id': user_id).sort('users.creation_date': -1).toArray()\n\n  bookshelf__add: ({ book_id, user_id }) ->\n    book = bookapi.findId(book_id)\n    try\n      result = @db.collection(booksdb_name)\n      .findOneAndUpdate(\n        { _id: book_id, 'users.user_id': $ne: user_id },\n        {\n          $set:\n            book: book\n            updated: new Date\n          $push: users:\n            user_id: user_id\n            creation_date: new Date\n        },\n        { returnOriginal: false, upsert: true })\n      e.emit 'book.update', result.value\n      return result.value\n    catch err\n      console.log 'db.js bookshelf__add err:', err\n      err\n\n  bookshelf__remove: ({ book_id, user_id }) ->\n    try\n      result = await @db.collection(booksdb_name).findOneAndUpdate(\n        { _id: book_id },\n        { $pull: users: user_id: user_id },\n        { returnOriginal: false })\n      return result.value\n    catch\n      console.log 'db.js bookshelf__remove err:', err\n      err\n\n  bookshelf__garbage_collection: ->\n    @db.collection(booksdb_name).remove users: $size: 0\n\n  trade__list: ({ book_id, user_id }) ->\n    result = @db.collection(booksdb_name).findOneAndUpdate(\n      { _id: book_id, 'users.user_id': user_id },\n      {\n        $set: 'users.$.trade':\n          creation_date: new Date\n          fullfilled: false\n          requests: []\n      },\n      { returnOriginal: false, upsert: false })\n    e.emit 'book.update', result.value\n    result.value\n\n  trade__unlist: ({ book_id, user_id }) ->\n    result = await @db.collection(booksdb_name).findOneAndUpdate(\n      { _id: book_id, 'users.user_id': user_id },\n      { $unset: 'users.$.trade': '' },\n      { returnOriginal: false, upsert: false })\n    e.emit 'book.update', result.value\n    result.value\n\n  tradeshelf: ({ user_id }) ->\n    @db.collection(booksdb_name).find(\n      'users.user_id': user_id\n      'users.trade': $exists: 1).toArray()\n\n  books_for_trade: ->\n    @db.collection(booksdb_name).find 'users.trade.fullfilled': false\n\n  trade__request: ({ book_id, owner_id, user_id }) ->\n    result = await @db.collection(booksdb_name).findOneAndUpdate(\n      {\n        _id: book_id\n        users: $elemMatch:\n          user_id: owner_id\n          'trade.fullfilled': false\n          'trade.requests.user_id': $ne: user_id\n      },\n      {\n        $push: 'users.$.trade.requests':\n          user_id: user_id\n          creation_date: new Date\n      },\n      { returnOriginal: false, upsert: false })\n\n    # new notifycation\n    @e.emit 'trade.request',\n      book_id: book_id\n      owner_id: owner_id\n      user_id: user_id\n      type: 'trade.request'\n      result: result.value\n    result.value\n\n  trade_respond: ({ request, accept_or_decline }) ->\n    request._id.request.creation_date = new Date request._id.request.creation_date\n    words = [ 'accept', 'decline' ]\n    if accept_or_decline == false\n      words = words.reverse()\n    doc = await @db.collection(booksdb_name).findOne(\n      _id: request.book._id\n      users: $elemMatch:\n        user_id: request._id.owner_id\n        'trade.requests': $elemMatch: request._id.request)\n    if doc == null then return Promise.reject()\n    i = doc.users.findIndex((user) -> request._id.owner_id == user.user_id)\n    if i == -1 then return Promise.reject()\n    j = doc.users[i].trade.requests.findIndex((user) -> request._id.request.user_id == user.user_id)\n    if j == -1 then return Promise.reject()\n\n    doc.users[i].trade.requests[j][words[0]] = true\n    doc.users[i].trade.requests[j][words[0] + '_date'] = new Date\n    delete doc.users[i].trade.requests[j][words[1]]\n    delete doc.users[i].trade.requests[j][words[1] + '_date']\n    result = await @db.collection(booksdb_name).findOneAndReplace(\n      { _id: doc._id },\n      doc,\n      { returnOriginal: false })\n    @e.emit 'book.update', result.value\n    @e.emit 'trade.respond',\n      book: result.value\n      request: request\n      words: words\n    result.value\n\n  trade_requests__get: ({ user_id, owner_id }) ->\n    firstPipe = $match: 'users.trade.requests': $exists: 1\n    lastPipe = $match: {}\n    if owner_id\n      firstPipe.$match['users.user_id'] = owner_id\n      lastPipe.$match['_id.owner_id'] = owner_id\n    if user_id\n      lastPipe.$match['_id.request.user_id'] = user_id\n    @db.collection(booksdb_name).aggregate([\n      firstPipe\n      { $project:\n        _id:\n          _id: '$_id'\n          title: '$book.title'\n        user: '$users' }\n      { $unwind: '$user' }\n      { $unwind: '$user.trade.requests' }\n      { $project:\n        _id:\n          owner_id: '$user.user_id'\n          request: '$user.trade.requests'\n        book: '$_id' }\n      lastPipe\n    ]).toArray()\n\n  book__get: ({ book_id }) ->\n    res = await @db.collection(booksdb_name).findOne(_id: book_id)\n    if res == null then return undefined else res\n  bookowners: ({ book_id }) ->\n    @db.collection('bookshelf').aggregate([\n      { $match: _id: book_id }\n      { $unwind: '$users' }\n      { $project:\n        _id:\n          user_id: '$users.user_id'\n          book_id: '$_id'\n        trade: '$users.trade' }\n      { $match: trade: $exists: 1 }\n      { $lookup:\n        from: 'bookshelf_users'\n        localField: '_id.user_id'\n        foreignField: '_id'\n        as: 'loci' }\n      { $unwind: '$loci' }\n      { $project:\n        _id: 0\n        user_id: '$_id.user_id'\n        book_id: '$_id.book_id'\n        trade: '$trade'\n        loci: '$loci.loci' }\n    ]).toArray()\n\n  market: ({ page_n }) ->\n    @db_paging\n      db: @db\n      coll: 'bookshelf'\n      query: 'users.trade': $exists: 1\n      limit: 20\n      page_n: page_n\n      sort: 'users.trade.creation_date': -1\n\n\n  notification__add: ({ user_id, info }) ->\n    note =\n      creation_date: new Date\n      read: false\n      opened: false\n    if info.type == 'trade.request'\n      note.path = '/book/' + info.book_id\n      note.message = '@' + info.user_id + ' requests \"' + info.result.book.title + '\"'\n    if info.type == 'trade.respond'\n      note.path = info.path\n      note.message = info.message\n    result = await @db.collection(usersdb_name).findOneAndUpdate(\n      { _id: user_id },\n      { $push: notifcations: note },\n      { returnOriginal: false })\n    @e.emit 'notify',\n      user: result.value\n      note: note\n    result.value\n\n  note__mark__read: ({ note, user_id }) ->\n    console.log user_id\n    result = await @db.collection(usersdb_name).findOneAndUpdate(\n      {\n        _id: user_id\n        notifcations: $elemMatch:\n          creation_date: new Date(note.creation_date)\n          message: note.message\n      },\n      { $set: 'notifcations.$.read': true },\n      { returnOriginal: false })\n    if result.value == null then return\n    e.emit 'notify',\n      user: result.value\n      note: note\n    result.value\n\n  note__mark__opened: ({ note, user_id }) ->\n    result = await @db.collection(usersdb_name).findOneAndUpdate(\n      {\n        _id: user_id\n        notifcations: $elemMatch:\n          creation_date: new Date(note.creation_date)\n          message: note.message\n      },\n      {\n        $set:\n          'notifcations.$.opened': true\n          'notifcations.$.read': true\n      },\n      { returnOriginal: false })\n    if result.value == null then return\n    console.log 'opend', result.value\n    e.emit 'notify',\n      user: result.value\n      note: note\n    result.value\n\n\n\n\n// WEBPACK FOOTER //\n// ./server/db.coffee","module.exports = require(\"mongodb\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"mongodb\"\n// module id = 19\n// module chunks = 0","curl = require('curl')\n\nmodule.exports = (ip) ->\n  url = 'http://ipinfo.io/' + ip + '/json'\n  console.log 'ip', ip\n  if (\n    ip == '::1' or\n    ip == '127.0.0.1' or\n    ip == undefined or\n    ip.match(/^\\:\\:/) != null\n  )\n    url = 'http://ipinfo.io/json'\n  \n  new Promise (resolve, reject) ->\n    curl.getJSON url, {}, (err, response, data) ->\n      #console.log(data)\n      if err\n        return reject(err)\n      [lat, lon] = data.loc.split(',')\n      loci =\n        name: \"\"\"\n          #{data.city}, #{data.region}, #{data.country}`\n        \"\"\"\n        coords: { lat, lon }\n        address:\n          city: data.city\n          region: data.region\n          country_code: data.country.toLowerCase()\n      resolve loci\n\n\n// WEBPACK FOOTER //\n// ./server/api/ip2loci.coffee","module.exports = require(\"curl\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"curl\"\n// module id = 21\n// module chunks = 0"],"sourceRoot":""}